name: Kinetic Workflow Sync

on:
  push:
    branches: [ main ]

# give the job write access to commit back to the repo
permissions:
  contents: write

jobs:
  reconcile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # full history so commits arenâ€™t shallow
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Kinetic Workflow
        id: run_kinetic
        run: |
          echo "ðŸŒ€ Running Kinetic reconciliation..."
          python scripts/kinetic_workflow.py --run > kinetic_output.log 2>&1 || {
            echo "âŒ Reconciliation failed"
            cat kinetic_output.log
            exit 1
          }
          echo "âœ… Reconciliation complete."

      - name: Run Kinetic Compiler
        id: run_compiler
        run: |
          echo "ðŸ§® Running Kinetic compiler..."
          python scripts/kinetic_compiler.py > kinetic_compiler.log 2>&1 || {
            echo "âŒ Compilation failed"
            cat kinetic_compiler.log
            exit 1
          }
          echo "âœ… Compilation complete."

      - name: Commit any reconciliation updates
        id: commit_changes
        run: |
          git config user.name "KineticBot"
          git config user.email "kinetic-bot@users.noreply.github.com"
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "[AUTO] Ledger reconciled by GitHub Action"
            # use the workflow's token to push
            git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            git push origin HEAD:main
            echo "changes_pushed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit."
            echo "changes_pushed=false" >> $GITHUB_OUTPUT
          fi

      - name: Print Summary
        if: always()
        run: |
          echo "ðŸ“Š --- Kinetic Sync Summary ---"
          total_rows=$(grep -c "^" Kinetic-ID-Index.csv || echo 0)
          new_ids=$(grep -E -c "\[Object ID:" S3.md || echo 0)
          echo "Total ledger rows: $total_rows"
          echo "Tasks in S3.md: $new_ids"
          echo "Changes pushed: ${{ steps.commit_changes.outputs.changes_pushed }}"
          echo "--------------------------------"